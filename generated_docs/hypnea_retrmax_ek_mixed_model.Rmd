---
title: "Mixed Model for Photosynthesis in Hypnea musciformis"
author: "Angela Richards Donà"
date: "5/19/2022"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
## Run 5.6 PHOTOSYNTHESIS Analysis, Script Chunks, and Plots

This is the analysis of the final run of the Hypnea musciformis salinity and nutrient experiments 
conducted on the lanai in St. John 616. These experiments incorporated four paired salinity
and nutrient levels with three temperature levels. Each run produced an n = 2 and was repeated
initially 8 times for a total of n = 16.
Data gaps were identified and filled by early March 2022. 
This output reflects all data totaling five treatments for Hypnea musciformis.

Packages loaded:

```{r message=FALSE}
library(lme4)
library(lmerTest)
library(effects)
library(car)
library(MuMIn)
library (dplyr)
library(emmeans)
library(DHARMa)
library(performance)
library(patchwork)
library(ggplot2)
library(ggpubr)
```

# Load and prepare the dataset
Open the output dataset generated by the ps_script_clean_to_ek_alpha.R script in
the phytotools_alpha_ek project

```{r}
run5_6_photosyn_data <- read.csv("/Users/Angela/src/work/limu/algal_growth_photosynthesis/data_input/run5-6_ek_alpha.csv")
```

Assign run as a factor
```{r}
run5_6_photosyn_data$Run <- as.factor(run5_6_photosyn_data$Run)
```

Assign temperature as a factor
```{r}
run5_6_photosyn_data$Temperature <- as.factor(run5_6_photosyn_data$Temp...C.)
```

Assign treatment as characters from integers then to factors
```{r}
run5_6_photosyn_data$Treatment <- as.factor(as.character(run5_6_photosyn_data$Treatment))
```

Subset the data and toggle between the species for output. Use Day 9 for final analysis ONLY
```{r}
hypnea <- subset(run5_6_photosyn_data, Species == "hm" & RLC.Day == 9)
```

Add a column for growth rate from growth rate dataset to the alredy subsetted hypnea data frame
```{r}
growth_rate <- read.csv("/Users/Angela/src/work/limu/algal_growth_photosynthesis/data_input/run5-6_growth_all_042922.csv")
```
```{r, growth_rate}
gr_hypnea <- subset(growth_rate, Species == "Hm" & final.weight != 0.1017)
hypnea$growth_rate <- round((gr_hypnea$final.weight - gr_hypnea$Initial.weight) / gr_hypnea$Initial.weight * 100, digits = 2)
```

rETRmax -- Run the model
Run model for rETRmax with two fixed effect variables and three random effects variables

```{r, hypnea}
run5_6_photosyn_model_noint <- lmer(formula = rETRmax ~ Treatment + Temperature 
                                    + (1 | Run) + (1 | Plant.ID) + (1 | RLC.Order), 
                                    data = hypnea)
```

rETRmax -- Make a histogram and residual plots of the data
```{r, run5_6_photosyn_model_noint, fig.width=5}
hist(hypnea$rETRmax, main = paste("Hypnea musciformis rETRmax"), col = "firebrick1", labels = TRUE)
plot(resid(run5_6_photosyn_model_noint) ~ fitted(run5_6_photosyn_model_noint))
qqnorm(resid(run5_6_photosyn_model_noint))
qqline(resid(run5_6_photosyn_model_noint))
```

rETRmax -- Check the performance of the model
```{r, fig.height=8}
performance::check_model(run5_6_photosyn_model_noint)
```

These outputs show the model is acceptable

rETRmax -- Check r2 for model fit and print the model statistics summary
```{r}
r.squaredGLMM(run5_6_photosyn_model_noint)
summary(run5_6_photosyn_model_noint)
```

rETRmax -- Run an ANOVA and pairwise comparisons based on ANOVA results
Results for temperature are non-significant, thus no pairwise comparisons for this
```{r}
anova(run5_6_photosyn_model_noint, type = c("III"), ddf = "Satterthwaite")
hypnea_photosyn_model_aov <- aov(rETRmax ~ Treatment + Temperature, data = hypnea)
TukeyHSD(hypnea_photosyn_model_aov, "Treatment", ordered = FALSE)
TukeyHSD(hypnea_photosyn_model_aov, "Temperature", ordered = FALSE)
```

rETRmax -- Plot the results
```{r}
plot(allEffects(run5_6_photosyn_model_noint))
```

Plot a regression between the photosynthetic independent variables of interest and growth rate
```{r}
hypnea_growth_etr_graph <- ggplot(hypnea, aes(x=rETRmax, y=growth_rate)) + geom_point() + 
  geom_smooth(method = "lm", col = "black") + theme_bw() + 
  labs(title = "Hypnea musciformis rETRmax vs Growth Rate", x = "rETRmax (μmols electrons m-2 s-1)", 
       y = "growth rate (%)") + stat_regline_equation(label.x = 25, label.y = 165) + stat_cor()
hypnea_growth_etr_graph
```


# Ek -- Run the model

Run model for minimum saturating irradiance (Ek) with two fixed effect variables
and three random effects variables
```{r}
run5_6_photosyn_model_noint <- lmer(formula = ek.1 ~ Treatment + Temperature 
                                    + (1 | Run) + (1 | Plant.ID) + (1 | RLC.Order), 
                                    data = hypnea)
```

Ek -- Make a histogram and residual plots of the data for hypnea
```{r, fig.width=5}
hist(hypnea$ek.1, main = paste("Hypnea musciformis Ek"), col = "firebrick2", labels = TRUE)
plot(resid(run5_6_photosyn_model_noint) ~ fitted(run5_6_photosyn_model_noint))
qqnorm(resid(run5_6_photosyn_model_noint))
qqline(resid(run5_6_photosyn_model_noint))
```

Ek -- Check the performance of the model
```{r, fig.height=8}
performance::check_model(run5_6_photosyn_model_noint)
```

Ek -- Check r2 for model fit and print the model statistics summary
```{r}
r.squaredGLMM(run5_6_photosyn_model_noint)
summary(run5_6_photosyn_model_noint)
```

 Ek -- Run an ANOVA and pairwise comparisons based on ANOVA results
```{r}
anova(run5_6_photosyn_model_noint, type = c("III"), ddf = "Satterthwaite")
hypnea_photosyn_model_aov <- aov(ek.1 ~ Treatment + Temperature, data = hypnea)
TukeyHSD(hypnea_photosyn_model_aov, "Treatment", ordered = FALSE)
TukeyHSD(hypnea_photosyn_model_aov, "Temperature", ordered = FALSE)
```

Ek -- Plot the results
```{r}
plot(allEffects(run5_6_photosyn_model_noint))
```

```{r}
hypnea_growth_ek_graph <- ggplot(hypnea, aes(x=ek.1, y=growth_rate)) + geom_point() + 
  geom_smooth(method = "lm", col = "black") + theme_bw() + 
  labs(title = "Hypnea musciformis Ek vs Growth Rate", x = "Ek (μmols photons m-2 s-1)", y = "growth rate (%)") + 
  stat_regline_equation() + stat_cor(label.y = 160)
hypnea_growth_ek_graph
```

# alpha -- Run the model

Run model for alpha with two fixed effect variables and three random effects variables

```{r}
run5_6_photosyn_model_noint <- lmer(formula = alpha.1 ~ Treatment + Temperature 
                                    + (1 | Run) + (1 | Plant.ID) + (1 | RLC.Order), 
                                    data = hypnea)
```

alpha -- Make a histogram and residual plots of the data for hypnea

```{r, fig.width=5}
hist(hypnea$alpha.1, main = paste("Hypnea musciformis alpha"), col = "firebrick3", labels = TRUE)
plot(resid(run5_6_photosyn_model_noint) ~ fitted(run5_6_photosyn_model_noint))
qqnorm(resid(run5_6_photosyn_model_noint))
qqline(resid(run5_6_photosyn_model_noint))
```

 alpha -- Check the performance of the model
```{r, fig.height=8}
performance::check_model(run5_6_photosyn_model_noint)
```

 alpha -- Check r2 for model fit and print the model statistics summary
```{r}
r.squaredGLMM(run5_6_photosyn_model_noint)
summary(run5_6_photosyn_model_noint)
```

alpha -- Run an ANOVA and pairwise comparisons based on ANOVA results
```{r}
anova(run5_6_photosyn_model_noint, type = c("III"), ddf = "Satterthwaite")
hypnea_photosyn_model_aov <- aov(alpha.1 ~ Treatment + Temperature, data = hypnea)
TukeyHSD(hypnea_photosyn_model_aov, "Treatment", ordered = FALSE)
TukeyHSD(hypnea_photosyn_model_aov, "Temperature", ordered = FALSE)
```

alpha -- Plot the results
```{r}
plot(allEffects(run5_6_photosyn_model_noint))
```



Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
