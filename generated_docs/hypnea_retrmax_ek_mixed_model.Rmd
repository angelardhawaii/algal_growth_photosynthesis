---
title: "Mixed Model for Photosynthesis in Hypnea musciformis"
author: "Angela Richards Donà"
date: "10/31/2022"
output:
  html_document:
    df_print: paged
---

All runs Hypnea musciformis PHOTOSYNTHESIS Analysis, Script Chunks, and Plots

This is the analysis of all the Hypnea musciformis salinity and nutrient experiments 
conducted on the lanai in St. John 616 from September 2021 to October 2022. These experiments incorporated four paired salinity
and nutrient treatments with three temperatures. Each of the first four runs produced an n = 2 and was repeated
initially 8 times for a total of n = 16.
Data gaps were identified and filled in February, April, and October 2022. 
This output reflects all data totaling six treatments for Hypnea only.

Packages loaded:

```{r message=FALSE}
library(lme4)
library(lmerTest)
library(effects)
library(car)
library(MuMIn)
library (dplyr)
library(emmeans)
library(DHARMa)
library(performance)
library(patchwork)
library(rstatix)
#for plots and tables
library(ggplot2)
library(ggpubr)
library(forcats)
library(RColorBrewer)
library(tidyverse)
library(sjPlot)
library(sjmisc)
#library(mmtable2)
library(gt)
library(purrr)
library(stringr)
library(tidyr)
```

## Load and prepare the dataset
Open the output dataset generated by the ps_script_clean_to_ek_alpha.R script in
the phytotools_alpha_ek project
This file was normalized to quantum efficiency of photosynthesis as this 
seems to be more accurate (changed in fitWebb input) per Silsbe and Kromkamp (2012)

```{r}
all_runs_photosyn_data <- read.csv("../data_input/hyp_ulva_all_runs_ek_alpha_normalized.csv")
```

Assign run as a factor
```{r}
all_runs_photosyn_data$Run <- as.factor(all_runs_photosyn_data$Run)
```

Assign temperature as a factor
```{r}
all_runs_photosyn_data$Temperature <- as.factor(all_runs_photosyn_data$Temp...C.)
```

Assign treatment as characters from integers then to factors
```{r}
all_runs_photosyn_data$Treatment <- as.factor(as.character(all_runs_photosyn_data$Treatment))
```

Assign deltaNPQ as a factor
```{r}
all_runs_photosyn_data$deltaNPQ <- as.factor(all_runs_photosyn_data$deltaNPQ)
```


Subset the data and toggle between the species for output. Use Day 9 for final analysis ONLY
This will also assign the proper labels for plots
```{r}
hypnea <- subset(all_runs_photosyn_data, Species == "hm" & RLC.Day == 9 & ek.1 < 226)
hypnea$treatment_graph[hypnea$Treatment == 0] <- "1) 35ppt/0.5umol"
hypnea$treatment_graph[hypnea$Treatment == 1] <- "2) 35ppt/14umol" 
hypnea$treatment_graph[hypnea$Treatment == 2] <- "3) 28ppt/27umol" 
hypnea$treatment_graph[hypnea$Treatment == 3] <- "5) 18ppt/53umol" 
hypnea$treatment_graph[hypnea$Treatment == 4] <- "6) 11ppt/80umol"
hypnea$treatment_graph[hypnea$Treatment == 2.5] <- "4) 28ppt/53umol"
```

Add a column for growth rate from growth rate dataset to the already subsetted hypnea data frame
```{r}
growth_rate <- read.csv("/Users/Angela/src/work/limu/algal_growth_photosynthesis/data_input/all_runs_growth_102222.csv")
growth_rate$Species <- as.factor(growth_rate$Species)
growth_rate$treatment <- as.factor(growth_rate$treatment)
```

Subset for hypnea only and calculate growth rate from final and initial weights
```{r, growth_rate}
gr_hypnea <- subset(growth_rate, Species == "Hm" & final.weight != 0.1017 & final.weight != 0.3224)
hypnea$growth_rate <- round((gr_hypnea$final.weight - gr_hypnea$Initial.weight) / gr_hypnea$Initial.weight * 100, digits = 2)
```

#Run the model
Run model for rETRmax with two fixed effect variables and three random effects variables

```{r hypnea}
#run model without interaction between the treatments and temperature
all_runs_photosyn_model_noint <- lmer(formula = rETRmax ~ Treatment + Temperature + (1 | Run)
                                      + (1 | Plant.ID) + (1 | RLC.Order), data = hypnea)
```

rETRmax -- Make a histogram and residual plots of the data

```{r, all_runs_photosyn_model_noint, fig.width=5}
hist(hypnea$rETRmax, main = paste("Hypnea musciformis rETRmax"), col = "olivedrab3", labels = TRUE)
#or
hypnea %>% ggplot(aes(rETRmax)) +
  geom_histogram(binwidth=5, fill = "#5BB300", color = "black", size = 0.25, alpha = 0.85) +
  theme_bw()
plot(resid(all_runs_photosyn_model_noint) ~ fitted(all_runs_photosyn_model_noint))
qqnorm(resid(all_runs_photosyn_model_noint))
qqline(resid(all_runs_photosyn_model_noint))
```

rETRmax -- Check the performance of the model
```{r, fig.height=8}
performance::check_model(all_runs_photosyn_model_noint)
```

These outputs show the model is acceptable

rETRmax -- Check r2 for model fit and print the model statistics summary
```{r}
r.squaredGLMM(all_runs_photosyn_model_noint)
summary(all_runs_photosyn_model_noint)
```

Use Bartlett's test to check for equal variance

``` {r}
bartlett.test(rETRmax ~ Treatment, data = hypnea)
```

Run Welch's ANOVA if not equal variances
```{r}
welch_anova_treatment <- oneway.test(rETRmax ~ Treatment, data = hypnea, var.equal = FALSE)
welch_anova_treatment
welch_anova_temp <- oneway.test(rETRmax ~ Temperature, data = hypnea, var.equal = FALSE)
welch_anova_temp
games_howell_test(hypnea, rETRmax ~ Treatment, conf.level = 0.95, detailed = TRUE)
```

rETRmax -- Plot and make a table of the results. Also get means for the treatments
```{r}
plot(allEffects(all_runs_photosyn_model_noint))
tab_model(all_runs_photosyn_model_noint)

hypnea %>% group_by(Treatment) %>% summarise_at(vars(rETRmax), list(mean = mean))

hypnea %>% ggplot(aes(treatment_graph, rETRmax)) + 
  geom_boxplot(size=0.5) + 
  geom_point(alpha = 0.5, size = 3, aes(color = Temperature), show.legend = FALSE) + 
  labs(x="salinity/nitrate", y= "rETRmax (μmols electrons m-2 s-1)", title= "A", subtitle = "Hypnea musciformis") + 
  scale_x_discrete(labels = c("35ppt/0.5umolN", "35ppt/14umolN", "28ppt/27umolN", "28ppt/53umolN", "18ppt/53umolN", "11ppt/80umolN")) + 
  ylim(-1, 160) + stat_mean() + 
  geom_hline(yintercept=0, color = "purple", size = 0.5, alpha = 0.5) +
  theme_bw() +
  theme(plot.title = element_text(face = "bold", vjust = -15, hjust = 0.05), plot.subtitle = element_text(face = "italic", vjust = -20, hjust = 0.05))
```

Plot a regression between the photosynthetic independent variables of interest and growth rate
```{r}
#rETRmax vs. Growth rate
hypnea_growth_etr_graph <- ggplot(hypnea, aes(x=rETRmax, y=growth_rate)) + 
  geom_point(alpha = 0.5, size = 3, show.legend = TRUE, aes(color = Treatment)) + 
  geom_smooth(method = "lm", col = "black") + theme_bw() + 
  labs(title = "Hypnea musciformis rETRmax vs Growth Rate", x = "rETRmax (μmols electrons m-2 s-1)", 
       y = "growth rate (%)") + stat_regline_equation(label.x = 25, label.y = 165) + stat_cor()
hypnea_growth_etr_graph

#rETRmax vs. Ek
hypnea_growth_etr_ek_graph <- ggplot(hypnea, aes(x=rETRmax, y=ek.1)) + 
  geom_point(alpha = 0.5, size = 3, show.legend = TRUE, aes(color = Treatment)) + 
  geom_smooth(method = "lm", col = "black") + theme_bw() + 
  labs(title = "Hypnea musciformis rETRmax vs Ek", x = "rETRmax (μmols electrons m-2 s-1)", 
       y = "Ek (μmols photons m-2 s-1)") + stat_regline_equation(label.x = 25, label.y = 165) + stat_cor()
hypnea_growth_etr_ek_graph
```

Temperature did not have a significant effect on the outcome for rETRmax

# Ek -- Run the model

Run model for minimum saturating irradiance (Ek) with two fixed effect variables
and three random effects variables

```{r}
all_runs_photosyn_model_ek <- lmer(formula = ek.1 ~ Treatment + Temperature + (1 | Run)
                                      + (1 | Plant.ID) + (1 | RLC.Order), data = hypnea)
```

Ek -- Make a histogram and residual plots of the data for hypnea
```{r, fig.width=5}
hist(hypnea$ek.1, main = paste("Hypnea musciformis Ek"), col = "darkolivegreen3", labels = TRUE)
plot(resid(all_runs_photosyn_model_ek) ~ fitted(all_runs_photosyn_model_ek))
qqnorm(resid(all_runs_photosyn_model_ek))
qqline(resid(all_runs_photosyn_model_ek))

hypnea %>% ggplot(aes(ek.1)) +
  geom_histogram(binwidth=5, fill = "#5BB300", color = "black", size = 0.25, alpha = 0.85) +
  theme_bw()
```

Ek -- Check the performance of the model
```{r, fig.height=8}
performance::check_model(all_runs_photosyn_model_ek)
```

Ek -- Check r2 for model fit and print the model statistics summary
```{r}
r.squaredGLMM(all_runs_photosyn_model_ek)
summary(all_runs_photosyn_model_ek)
```

Ek -- Run Bartlett's test and Welch's ANOVA with Games Howell test for pairwise comparisons
```{r}
bartlett.test(ek.1 ~ Treatment, data = hypnea)
welch_anova_treatment <- oneway.test(ek.1 ~ Treatment, data = hypnea, var.equal = FALSE)
welch_anova_treatment
welch_anova_temp <- oneway.test(ek.1 ~ Temperature, data = hypnea, var.equal = FALSE)
welch_anova_temp
games_howell_test(hypnea, ek.1 ~ Treatment, conf.level = 0.95, detailed = TRUE)
```

Ek -- Plots and tables for the results
```{r}
tab_model(all_runs_photosyn_model_ek)
plot(allEffects(all_runs_photosyn_model_ek))
hypnea %>% group_by(Treatment) %>% summarise_at(vars(ek.1), list(mean = mean))

hypnea %>% ggplot(aes(treatment_graph, ek.1)) + 
  geom_boxplot(size=0.5) + 
  geom_point(alpha = 0.5, size = 3, aes(color = Temperature), show.legend = FALSE) + 
  labs(x="salinity/nitrate", y= "Ek (μmols photons m-2 s-1)", title= "A", subtitle = "Hypnea musciformis") + 
  scale_x_discrete(labels = c("35ppt/0.5umolN", "35ppt/14umolN", "28ppt/27umolN", "28ppt/53umolN", "18ppt/53umolN", "11ppt/80umolN")) + 
  ylim(-1, 160) + stat_mean() + 
  geom_hline(yintercept=0, color = "purple", size = 0.5, alpha = 0.5) +
  theme_bw() +
  theme(plot.title = element_text(face = "bold", vjust = -15, hjust = 0.05), plot.subtitle = element_text(face = "italic", vjust = -20, hjust = 0.05))
```

plot linear regression Ek with growth rate
```{r}
hypnea_growth_etr_graph <- ggplot(hypnea, aes(x=ek.1, y=growth_rate)) + 
  geom_point(alpha = 0.5, size = 3, show.legend = TRUE, aes(color = Treatment)) + 
  geom_smooth(method = "lm", col = "black") + theme_bw() + 
  labs(title = "Hypnea musciformis Ek vs Growth Rate", x = "Ek (μmols photons m-2 s-1)", 
       y = "growth rate (%)") + stat_regline_equation(label.x = 25, label.y = 165) + stat_cor()
hypnea_growth_etr_graph
```

