---
title: "Linear Mixed Model for Photosynthesis in Ulva lactuca"
author: "Angela Richards Donà"
date: "10/30/2022"
output:
  html_document:
    df_print: paged
---

All runs Ulva PHOTOSYNTHESIS Analysis, Script Chunks, and Plots

This is the analysis of all the Ulva lactuca salinity and nutrient experiments 
conducted on the lanai in St. John 616 from September 2021 to October 2022. These experiments incorporated four paired salinity
and nutrient treatments with three temperatures. Each of the first four runs produced an n = 2 and was repeated
initially 8 times for a total of n = 16.
Data gaps were identified and filled in February, April, and October 2022. 
This output reflects all data totaling six treatments for Ulva lactuca.

Packages loaded:

```{r message=FALSE}
library(lme4)
library(lmerTest)
library(effects)
library(car)
library(MuMIn)
library (dplyr)
library(emmeans)
library(DHARMa)
library(performance)
library(patchwork)
library(rstatix)
#for plots and tables
library(ggplot2)
library(ggpubr)
library(forcats)
library(RColorBrewer)
library(tidyverse)
library(sjPlot)
library(sjmisc)
#library(mmtable2)
library(gt)
library(purrr)
library(stringr)
library(tidyr)
```

## Load and prepare the dataset
Open the output dataset generated by the ps_script_clean_to_ek_alpha.R script in
the phytotools_alpha_ek project
This file was normalized to quantum efficiency of photosynthesis as this 
seems to be more accurate (changed in fitWebb input) per Silsbe and Kromkamp (2012)

```{r}
all_runs_photosyn_data <- read.csv("../data_input/hyp_ulva_all_runs_ek_alpha_normalized.csv")
```

Assign run as a factor
```{r}
all_runs_photosyn_data$Run <- as.factor(all_runs_photosyn_data$Run)
```

Assign temperature as a factor
```{r}
all_runs_photosyn_data$Temperature <- as.factor(all_runs_photosyn_data$Temp...C.)
```

Assign treatment as characters from integers then to factors
```{r}
all_runs_photosyn_data$Treatment <- as.factor(as.character(all_runs_photosyn_data$Treatment))
```

Assign deltaNPQ as a factor
```{r}
all_runs_photosyn_data$deltaNPQ <- as.factor(all_runs_photosyn_data$deltaNPQ)
```


Subset the data and toggle between the species for output. Use Day 9 for final analysis ONLY
This will also assign the proper labels for plots
```{r}
ulva <- subset(all_runs_photosyn_data, Species == "ul" & RLC.Day == 9)
ulva$treatment_graph[ulva$Treatment == 0] <- "1) 35ppt/0.5umol"
ulva$treatment_graph[ulva$Treatment == 1] <- "2) 35ppt/14umol" 
ulva$treatment_graph[ulva$Treatment == 2] <- "3) 28ppt/27umol" 
ulva$treatment_graph[ulva$Treatment == 3] <- "5) 18ppt/53umol" 
ulva$treatment_graph[ulva$Treatment == 4] <- "6) 11ppt/80umol"
ulva$treatment_graph[ulva$Treatment == 2.5] <- "4) 28ppt/53umol"
```

Add a column for growth rate from growth rate dataset to the already subsetted Ulva data frame
```{r}
growth_rate <- read.csv("/Users/Angela/src/work/limu/algal_growth_photosynthesis/data_input/all_runs_growth_102222.csv")
growth_rate$Species <- as.factor(growth_rate$Species)
growth_rate$treatment <- as.factor(growth_rate$treatment)
```

Subset for Ulva only and calculate growth rate from final and initial weights
```{r, growth_rate}
gr_ulva <- subset(growth_rate, Species == "Ul")
ulva$growth_rate <- round((gr_ulva$final.weight - gr_ulva$Initial.weight) / gr_ulva$Initial.weight * 100, digits = 2)
```

#Run the model
Run model for rETRmax with two fixed effect variables and three random effects variables

```{r ulva}
#run model without interaction between the treatments and temperature
all_runs_photosyn_model_noint <- lmer(formula = rETRmax ~ Treatment + Temperature + (1 | Run)
                                      + (1 | Plant.ID) + (1 | RLC.Order), data = ulva)
```

rETRmax -- Make a histogram and residual plots of the data

```{r, all_runs_photosyn_model_noint, fig.width=5}
hist(ulva$rETRmax, main = paste("Ulva lactuca rETRmax"), col = "olivedrab3", labels = TRUE)
#or
ulva %>% ggplot(aes(rETRmax)) +
  geom_histogram(binwidth=5, fill = "#5BB300", color = "black", size = 0.25, alpha = 0.85) +
  theme_bw()
plot(resid(all_runs_photosyn_model_noint) ~ fitted(all_runs_photosyn_model_noint))
qqnorm(resid(all_runs_photosyn_model_noint))
qqline(resid(all_runs_photosyn_model_noint))
```

rETRmax -- Check the performance of the model
```{r, fig.height=8}
performance::check_model(all_runs_photosyn_model_noint)
```

These outputs show the model is acceptable

rETRmax -- Check r2 for model fit and print the model statistics summary
```{r}
r.squaredGLMM(all_runs_photosyn_model_noint)
summary(all_runs_photosyn_model_noint)
```

Use Bartlett's test to check for equal variance

``` {r}
bartlett.test(rETRmax ~ Treatment, data = ulva)
```

Run Welch's ANOVA if not equal variances
```{r}
welch_anova_treatment <- oneway.test(rETRmax ~ Treatment, data = ulva, var.equal = FALSE)
welch_anova_treatment
welch_anova_temp <- oneway.test(rETRmax ~ Temperature, data = ulva, var.equal = FALSE)
welch_anova_temp
games_howell_test(ulva, rETRmax ~ Treatment, conf.level = 0.95, detailed = TRUE)
```

rETRmax -- Plot and make a table of the results. Also get means for the treatments
```{r}
plot(allEffects(all_runs_photosyn_model_noint))
tab_model(all_runs_photosyn_model_noint)

ulva %>% group_by(Treatment) %>% summarise_at(vars(rETRmax), list(mean = mean))

ulva %>% ggplot(aes(treatment_graph, rETRmax)) + 
  geom_boxplot(size=0.5) + 
  geom_point(alpha = 0.5, size = 3, aes(color = Temperature), show.legend = FALSE) + 
  labs(x="salinity/nitrate", y= "rETRmax (μmols electrons m-2 s-1)", title= "A", subtitle = "Ulva lactuca") + 
  scale_x_discrete(labels = c("35ppt/0.5umolN", "35ppt/14umolN", "28ppt/27umolN", "28ppt/53umolN", "18ppt/53umolN", "11ppt/80umolN")) + 
  ylim(-1, 160) + stat_mean() + 
  geom_hline(yintercept=0, color = "purple", size = 0.5, alpha = 0.5) +
  theme_bw() +
  theme(plot.title = element_text(face = "bold", vjust = -15, hjust = 0.05), plot.subtitle = element_text(face = "italic", vjust = -20, hjust = 0.05))
```

Plot a regression between the photosynthetic independent variables of interest and growth rate
```{r}
ulva_growth_etr_graph <- ggplot(ulva, aes(x=rETRmax, y=growth_rate)) + 
  geom_point(alpha = 0.5, size = 3, show.legend = TRUE, aes(color = Treatment)) + 
  geom_smooth(method = "lm", col = "black") + theme_bw() + 
  labs(title = "Ulva lactuca rETRmax vs Growth Rate", x = "rETRmax (μmols electrons m-2 s-1)", 
       y = "growth rate (%)") + stat_regline_equation(label.x = 25, label.y = 165) + stat_cor()
ulva_growth_etr_graph
```

Temperature did not have a significant effect on the outcome for rETRmax

# Ek -- Run the model

Run model for minimum saturating irradiance (Ek) with two fixed effect variables
and three random effects variables

```{r}
all_runs_photosyn_model_ek <- lmer(formula = ek.1 ~ Treatment + Temperature + (1 | Run)
                                      + (1 | Plant.ID) + (1 | RLC.Order), data = ulva)
```

Ek -- Make a histogram and residual plots of the data for ulva
```{r, fig.width=5}
hist(ulva$ek.1, main = paste("Ulva lactuca Ek"), col = "darkolivegreen3", labels = TRUE)
plot(resid(all_runs_photosyn_model_ek) ~ fitted(all_runs_photosyn_model_ek))
qqnorm(resid(all_runs_photosyn_model_ek))
qqline(resid(all_runs_photosyn_model_ek))

ulva %>% ggplot(aes(ek.1)) +
  geom_histogram(binwidth=5, fill = "#5BB300", color = "black", size = 0.25, alpha = 0.85) +
  theme_bw()
```

Ek -- Check the performance of the model
```{r, fig.height=8}
performance::check_model(all_runs_photosyn_model_ek)
```

Ek -- Check r2 for model fit and print the model statistics summary
```{r}
r.squaredGLMM(all_runs_photosyn_model_ek)
summary(all_runs_photosyn_model_ek)
```

Ek -- Run Bartlett's test and Welch's ANOVA with Games Howell test for pairwise comparisons
```{r}
bartlett.test(ek.1 ~ Treatment, data = ulva)
welch_anova_treatment <- oneway.test(ek.1 ~ Treatment, data = ulva, var.equal = FALSE)
welch_anova_treatment
welch_anova_temp <- oneway.test(ek.1 ~ Temperature, data = ulva, var.equal = FALSE)
welch_anova_temp
games_howell_test(ulva, ek.1 ~ Treatment, conf.level = 0.95, detailed = TRUE)
```

Ek -- Plots and tables for the results
```{r}
tab_model(all_runs_photosyn_model_ek)
plot(allEffects(all_runs_photosyn_model_ek))
ulva %>% group_by(Treatment) %>% summarise_at(vars(ek.1), list(mean = mean))

ulva %>% ggplot(aes(treatment_graph, ek.1)) + 
  geom_boxplot(size=0.5) + 
  geom_point(alpha = 0.5, size = 3, aes(color = Temperature), show.legend = FALSE) + 
  labs(x="salinity/nitrate", y= "Ek (μmols photons m-2 s-1)", title= "A", subtitle = "Ulva lactuca") + 
  scale_x_discrete(labels = c("35ppt/0.5umolN", "35ppt/14umolN", "28ppt/27umolN", "28ppt/53umolN", "18ppt/53umolN", "11ppt/80umolN")) + 
  ylim(-1, 160) + stat_mean() + 
  geom_hline(yintercept=0, color = "purple", size = 0.5, alpha = 0.5) +
  theme_bw() +
  theme(plot.title = element_text(face = "bold", vjust = -15, hjust = 0.05), plot.subtitle = element_text(face = "italic", vjust = -20, hjust = 0.05))
```

plot linear regression Ek with growth rate
```{r}
ulva_growth_etr_graph <- ggplot(ulva, aes(x=ek.1, y=growth_rate)) + 
  geom_point(alpha = 0.5, size = 3, show.legend = TRUE, aes(color = Treatment)) + 
  geom_smooth(method = "lm", col = "black") + theme_bw() + 
  labs(title = "Ulva lactuca Ek vs Growth Rate", x = "Ek (μmols photons m-2 s-1)", 
       y = "growth rate (%)") + stat_regline_equation(label.x = 25, label.y = 165) + stat_cor()
ulva_growth_etr_graph
```

